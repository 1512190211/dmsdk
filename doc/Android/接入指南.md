# 接入指南

以下流程（从注册AppID到Manifest配置）适用于新接入本SDK，如果您需要从原有的SDK迁移到新版本，请参阅[常见问题](常见问题.md)中的相关章节，其中有针对每个版本的API变更和就版本迁移指南。**新版本会带来更多特性、修复缺陷，请尽量保持使用最新的SDK版本。**

DMSDK Android提供[Javadoc](https://tencentdingdang.github.io/dmsdk/android/2.1.4/javadoc/index.html)作为API文档。

## 1. 配置Gradle脚本

打开工程app目录下的build.gradle。

配置依赖：

```groovy
dependencies {
    // ...
    def tvsVer = '2.1.4'
    // 核心模块，被其他组件依赖
    implementation "com.tencent.yunxiaowei.dmsdk:core:$tvsVer"
    // AI Speech模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:aispeech:$tvsVer"
    // QQ音乐会员模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:member:$tvsVer"
    // 二维码业务模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:qrcode:$tvsVer"
    // 音箱配置模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:speaker:$tvsVer"
    // TSKM技能服务模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:tskm:$tvsVer"
    // HTML5 WebView模块，可选
    implementation "com.tencent.yunxiaowei.dmsdk:web:$tvsVer"
    // 微信登录，如果需要微信登录功能则必须
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:5.4.0'
    // QQ登录，如果需要QQ登录功能则必须
    implementation files('libs/open_sdk_r6052_lite.jar')
    // QQ登录SDK依赖该库
    implementation 'com.android.support:support-fragment:28.0.0'
}
```

确保minSdkVersion大于等于15。

DMSDK已经通过ConsumerProguard自动支持ProGuard配置，不需要您为DMSDK额外配置ProGuard文件。

## 2. 接入微信、QQ登录

如果需要使用DMSDK的微信登录和QQ登录功能，则需要进行以下的配置。

如果不使用这些登录方式，可以直接跳过本节。

### 2.1. 准备App ID

在[微信开放平台](https://open.weixin.qq.com/)和[QQ互联平台](https://connect.qq.com/index.html)注册AppId。注意确保申请时填写的包名和应用包名一致、并确保signingConfigs目录下storeFile.file参数路径正确，keyAlias、keyPassword、storePassword均与微信开放平台下签名参数一致。

### 2.2. 配置项目

打开工程AndroidManifest.xml。

如果要接入微信，需要在application标签下添加以下内容：

```xml
<activity
    android:name="com.tencent.ai.tvs.WXEntryActivity"
    android:exported="true"
    android:launchMode="singleTask" />
<activity-alias
    android:name="${applicationId}.wxapi.WXEntryActivity"
    android:exported="true"
    android:launchMode="singleTask"
    android:targetActivity="com.tencent.ai.tvs.WXEntryActivity" />
```

`com.tencent.ai.tvs.WXEntryActivity`是DMSDK提供的WXEntryActivity默认实现。

如果需要自定义该Activity的实现，则需要在onReq和onResp中调用DMSDK的相关接口，如下所示：

```java
@Override
public void onReq(BaseReq baseReq) {
    if (!LoginProxy.getInstance().onReq(baseReq)) {
        // 在此处添加您的自定义实现
        Toast.makeText(this, "DMSDK didn't handle onReq", Toast.LENGTH_SHORT).show();
    }
}

@Override
public void onResp(BaseResp baseResp) {
    if (!LoginProxy.getInstance().onResp(baseResp)) {
        // 在此处添加您的自定义实现，如响应微信分享回调
        Toast.makeText(this, "DMSDK didn't handle onResp", Toast.LENGTH_SHORT).show();
    }
}
```

详细请参考demo工程中提供的示例WXEntryActivity类。

如果要接入QQ登录，则需要在Manifest中的application标签下添加以下内容：

```xml
<activity
    android:name="com.tencent.tauth.AuthActivity"
    android:launchMode="singleTask"
    android:noHistory="true">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <!-- 注意：此处您需要按照QQ互联的文档配置您申请的QQ登录API -->
        <data android:scheme="tencent101470979" />
    </intent-filter>
</activity>
<activity
    android:name="com.tencent.connect.common.AssistActivity"
    android:configChanges="orientation|keyboardHidden"
    android:screenOrientation="behind"
    android:theme="@android:style/Theme.Translucent.NoTitleBar" />
```

注意需要将示例中的AppID改为自己在QQ互联平台注册的AppID。

以上接入流程基于微信和QQ的登录SDK的官方接入文档，详细请参考对应的文档。

## 3. 接入第三方账号方案

DMSDK的接口几乎都需要登录后调用，若您的App没有接入微信、QQ登录，而是自建了账号体系，那么需要提供自定义的实现，以提供账号Token信息以供DMSDK用于请求认证。目前TSKM模块中的各组件均支持第三方账号。

如果不需要接入第三方账号，可以直接跳过本节。

我们需要实现一个自定义的`AuthDelegate`，用于提供账号ID等信息，实例实现如下：

```java
public class MyAuthDelegate implements AuthDelegate {
    @Override
    public void tvsWXLogin(TVSCallback callback) {
    }

    @Override
    public void tvsWXTokenRefresh(TVSCallback callback) {
    }

    @Override
    public void tvsQQOpenLogin(TVSCallback callback) {
    }

    @Override
    public void tvsLogout() {
    }

    @Override
    public TVSAccountInfo getAccountInfo() {
        TVSAccountInfo accountInfo = new TVSAccountInfo();
        accountInfo.setPlatform(ELoginPlatform.ThirdParty);
        accountInfo.setOpenID("ACCOUNT_ID_FOR_CURRENT_LOGGED_IN_USER");
        // 需要填写AppKey！
        accountInfo.setAppId(TvsDeviceUtil.getAppKey("YOUR_PRODUCT_ID"));
        return accountInfo;
    }

    @Override
    public TVSUserInfo getUserInfo() {
        return null;
    }

    @Override
    public void tvsSetPhoneNumber(String phoneNumber) {
    }
}
```

您只需要自定义`getAccountInfo`的实现，其他方法均不需要实现，留空即可。对于`getAccountInfo`返回的账号信息，目前您需要且只需要提供**三个字段**：

*   登录平台类型，使用`setPlatform`接口设置，必须为固定值`ELoginPlatform.ThirdParty`；
*   Open ID，使用`setOpenID`接口设置，该值表示在您应用的账号体系中当前登录用户的账号ID（即您的账号体系中每个账号的唯一标识）；
*   App ID，使用`setAppId`接口设置，该值填入您申请的产品的App Key，App Key可以从Product ID中获取，如上述范例代码所示。

## 4. Application配置

将Manifest中的application的name改为自定义的Application类，然后在其中的`onCreate`中加入如下初始化代码（以微信、QQ登录方式为例）：

```java
public class YourApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();

        // 初始化TVS账号体系模块，依次传入应用上下文、微信AppID和QQ互联AppID；如果只需要支持一种登录平台，则另一个平台的AppID直接传入空字符串即可
        // 如果需要使用第三方账号体系，或Web模块需要接入非DMSDK账号体系，可以传递到第四个参数，TVSWeb的init方法已经被废弃
        LoginProxy.getInstance().registerApp(this, "YOUR_WEIXIN_APPID", "YOUR_QQ_OPEN_APPID");
    }
}
```

如果您是接入第三方账号方案，则初始化时需要提供前面自定义的`AuthDelegate`，即改为如下的初始化调用：

```java
LoginProxy.getInstance().registerApp(appContext, "", "", mYourCustomAuthDelegate);
```
